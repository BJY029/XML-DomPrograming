import java.awt.EventQueue;
import java.awt.Font;

import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JScrollPane;
import javax.swing.JTextField;
import javax.swing.JTree;
import javax.swing.SwingConstants;
import javax.swing.SwingUtilities;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.event.TreeSelectionListener;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.TreePath;

import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.w3c.dom.Element;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;

public class DeleteFrame {

	private JFrame frame;
	private JTree tree;
	private JButton DeleteButton;
	private Node selectedNode;

	public void setVisible(boolean b) {
		frame.setVisible(b);
	}

	public void returnToMain() {
		SwingUtilities.invokeLater(() -> {
			JFrame toClose = this.frame; // 닫을 대상 보관
			MainFrame main = new MainFrame();
			main.setVisible(true); // 새 메인 띄우기
			if (toClose != null)
				toClose.dispose(); // 반드시 명시적으로 닫기
		});
	}
	
	public DeleteFrame() {
		initialize();
	}
	
	private void initialize() {
		frame = new JFrame();
		frame.setBounds(100, 100, 573, 750);
		frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		frame.getContentPane().setLayout(null);

		if (!FileData.isLoaded()) {
			JOptionPane.showMessageDialog(null, "No files have been loaded, please load the files first.", "ERROR",
					JOptionPane.ERROR_MESSAGE);
			returnToMain();
			return;
		}

		JLabel DeleteLabel = new JLabel("Delete");
		DeleteLabel.setFont(new Font("굴림", Font.PLAIN, 24));
		DeleteLabel.setHorizontalAlignment(SwingConstants.CENTER);
		DeleteLabel.setBounds(12, 10, 535, 45);
		frame.getContentPane().add(DeleteLabel);

		JScrollPane scrollPane = new JScrollPane();
		scrollPane.setBounds(12, 65, 535, 582);
		frame.getContentPane().add(scrollPane);

		JLabel DeletingLabel = new JLabel("Select the node to delete");
		DeletingLabel.setFont(new Font("굴림", Font.PLAIN, 20));
		DeletingLabel.setHorizontalAlignment(SwingConstants.CENTER);
		scrollPane.setColumnHeaderView(DeletingLabel);

		DefaultMutableTreeNode rootNode = DOMTreeBuilder.buildTree(FileData.document.getDocumentElement());
		tree = new JTree(rootNode);
		scrollPane.setViewportView(tree);
		tree.addTreeSelectionListener(new TreeSelectionListener() {
			@Override
			public void valueChanged(TreeSelectionEvent e) {
				TreePath path = tree.getSelectionPath();
				if (path == null)
					return;

				DefaultMutableTreeNode selectedTreeNode = (DefaultMutableTreeNode) path.getLastPathComponent();
				Object userObject = selectedTreeNode.getUserObject();

				if (userObject instanceof Node) {
					//System.out.println("event activated");
					Node getNode = (Node) userObject;

					selectedNode = getNode;
					DeleteButton.setEnabled(true);
				}
			}

		});

		JButton UpdateBtn = new JButton("Update");
		UpdateBtn.setFont(new Font("굴림", Font.PLAIN, 20));
		UpdateBtn.setBounds(12, 657, 127, 45);
		UpdateBtn.addActionListener(e -> UpdateJTree());
		frame.getContentPane().add(UpdateBtn);
		
		DeleteButton = new JButton("Delete");
		DeleteButton.setEnabled(false);
		DeleteButton.setFont(new Font("굴림", Font.PLAIN, 20));
		DeleteButton.addActionListener(e -> DeleteNode());
		DeleteButton.setBounds(216, 657, 127, 45);

		frame.getContentPane().add(DeleteButton);
		frame.setLocationRelativeTo(null);

		JButton finBtn = new JButton("Back to main");
		finBtn.setFont(new Font("굴림", Font.PLAIN, 18));
		finBtn.setBounds(385, 657, 162, 45);
		finBtn.addActionListener(e -> returnToMain());
		frame.getContentPane().add(finBtn);
	}
	
	private void UpdateJTree() {
		DefaultMutableTreeNode rootNode = DOMTreeBuilder.buildTree(FileData.document.getDocumentElement());
		DefaultTreeModel model = new DefaultTreeModel(rootNode);
		tree.setModel(model);
	}
	
	//노드 삭제 함수
	private void DeleteNode()
	{
		//선택된 노드의 타입을 받아온다.
		int type = selectedNode.getNodeType();
		//루트 노드가 선택된 경우 삭제를 막는다.
		if(type == Node.ELEMENT_NODE && selectedNode == FileData.document.getDocumentElement()) {
			JOptionPane.showMessageDialog(null, "The root element cannot be deleted.", "Warning", JOptionPane.WARNING_MESSAGE);
			return;
		}
		//선택된 노드의 부모 노드를 가져온다.
		Node parent = selectedNode.getParentNode();
		if(parent == null)
		{
			JOptionPane.showMessageDialog(null, "parent is null", "Warning", JOptionPane.WARNING_MESSAGE);
			return;
		}
		
		//선택된 노드가 Element 노드인 경우
		if(type == Node.ELEMENT_NODE) {
			//해당 노드를 Element 노들 변환
			Element ele = (Element)selectedNode;
			//해당 노드에 달린 Attribute들을 모두 불러오기
			NamedNodeMap atts = ele.getAttributes();
			boolean isAttDeleted = false;
			//attribute가 하나 이상 있는 경우
			if(atts != null && atts.getLength() > 0)
			{
				//속성값 부터 삭제할지 물어본다.
				//삭제는 뒤에서부터 수행한다.
				for(int i = atts.getLength() - 1; i >= 0; i--)
				{
					Node att = atts.item(i);
					String name = att.getNodeName();
					String value = att.getNodeValue();
					
					int result = JOptionPane.showConfirmDialog(frame, "Delete Attribute?\n" + name + " = " + value, "Confirm Attribute Deletion", JOptionPane.YES_NO_OPTION);
					if(result == JOptionPane.YES_OPTION)
					{
						ele.removeAttribute(name);
						isAttDeleted = true;
					}
				}
			}
			
			int choice = JOptionPane.showConfirmDialog(frame, "Delete Element \'" + ele.getNodeName() + "\'?","Confirm Element Deletion", JOptionPane.YES_NO_OPTION);
			if(choice == JOptionPane.YES_OPTION) {
				int idx = -1;
				NodeList list = parent.getChildNodes();
				for(int i = 0; i < list.getLength(); i++) {
					if(list.item(i) == selectedNode) {
						idx = i;
						break;
					}
				}
				if(idx == -1) {
					JOptionPane.showMessageDialog(null, "No such node", "Warning", JOptionPane.WARNING_MESSAGE);
					return;
				}
				Node selected_Node = list.item(idx);
				parent.removeChild(selected_Node);
				selected_Node = list.item(idx);
				parent.removeChild(selected_Node);
				
			}

			if(isAttDeleted)
			{
				JOptionPane.showMessageDialog(null, "Attribute/Element Deletion completed successfully.");
			}
			else {
				JOptionPane.showMessageDialog(null, "Deletion completed successfully.");
			}
		}
		else if(type == Node.TEXT_NODE || type == Node.COMMENT_NODE)
		{
			int idx = -1;
			NodeList list = parent.getChildNodes();
			for(int i = 0; i < list.getLength(); i++) {
				if(list.item(i) == selectedNode) {
					idx = i;
					break;
				}
			}
			if(idx == -1) {
				JOptionPane.showMessageDialog(null, "No such node", "Warning", JOptionPane.WARNING_MESSAGE);
				return;
			}
			Node selected_Node = list.item(idx);
			parent.removeChild(selected_Node);
			selected_Node = list.item(idx);
			parent.removeChild(selected_Node);
			
			JOptionPane.showMessageDialog(null, "Deletion completed successfully.");
		}
		
	}
	
}

	